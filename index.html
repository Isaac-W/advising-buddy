<!DOCTYPE html>
<html lang="en">

<head>
    <title>Schedule Checker</title>
    <meta charset="UTF-8">
    <link rel="icon" href="https://fav.farm/ğŸ“…">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #input {
            width: 400px;
            height: 100px;
        }

        #calendar {
            width: 1600px;
            height: 980px;
        }

        .fc-timegrid-slot {
            height: 2.2em !important;
        }

        .class-container {
            display: flex;
            flex-direction: column;
            padding: 0px 2px;
            font-size: small;
            font-family: "Open Sans", sans-serif;

            >* {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        .class-title {
            font-weight: bold;
        }

        .class-desc {
            font-weight: normal;
        }

        .class-walk {
            margin-right: 3px;
        }

        .class-loc {
            font-style: italic;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .side-by-side {
            display: flex;
            flex-direction: row;
            justify-content: flex-start;

            > * {
                margin-right: 20px;
            }
        }
    </style>
</head>

<body>
    <div id="top">
        <!-- <h1>Schedule Checker</h1> -->
        <div class="side-by-side">    
            <form>
                <h2>Paste advising record here:</h2>
                <textarea id="input" class="textbox"></textarea>
                <br>
                <button id="submit-btn" type="submit">Submit</button>
                <button id="clear-btn" type="button">Clear</button>
            </form>
            <div id="checklist">
                <h3>Checklist</h3>
                <ul>
                    
                </ul>
            </div>
        </div>
        <br>
        <hr>
    </div>
    <div id="schedule" hidden>
        <h1 id="schedule-title">Schedule</h1>
        <div id="buttons">
            <button id="copy-btn" type="button">Copy Image</button>
            <button id="download-btn" type="button">Download Image</button>
        </div>
        <div id="calendar"></div>
    </div>
    <script>
        // WALKING TIME

        const campusRegion = {
            "bluestone": ["Alumnae", "Burruss", "Carrier", "Harrison", "Darcus", "Johnston", "Keezell", "Gabbin", "Miller", "Moody", "Roop", "Sheldon", "Wilson"],
            "w.bluestone": ["Anthony", "Cleveland", "Duke", "Forbes", "Music", "Grace"],
            "memorial": ["Memorial", "Studio", "International"],
            "n.campus": ["Health", "Madison", "Student"],
            "hillside": ["Grafton", "Union"],
            "lakeside": ["Godwin", "Plecker", "Showker", "Hartman", "Lakeview", "Bridgeforth"],
            "skyline": ["Engineering", "King", "Physics", "Bioscience", "Festival", "Rose"],
            "ridge": ["Convocation", "Recreation", "Jennings"],
            "online": ["Online"]
        }

        const timeEstimates = {
            "bluestone": {
                "bluestone": "âœ…",
                "w.bluestone": "âœ…",
                "memorial": "âœ…",
                "n.campus": "âœ…",
                "hillside": "âœ…",
                "lakeside": "âœ…",
                "skyline": "âš ï¸",
                "ridge": "âš ï¸",
                "online": "âœ…",
            },
            "w.bluestone": {
                "bluestone": "âœ…",
                "w.bluestone": "âœ…",
                "memorial": "âœ…",
                "n.campus": "âœ…",
                "hillside": "âœ…",
                "lakeside": "âš ï¸",
                "skyline": "âš ï¸",
                "ridge": "ğŸ›‘",
                "online": "âœ…",
            },
            "memorial": {
                "bluestone": "âœ…",
                "w.bluestone": "âœ…",
                "memorial": "âœ…",
                "n.campus": "âœ…",
                "hillside": "âœ…",
                "lakeside": "ğŸ›‘",
                "skyline": "ğŸ›‘",
                "ridge": "ğŸ›‘",
                "online": "âœ…",
            },
            "n.campus": {
                "bluestone": "âœ…",
                "w.bluestone": "âœ…",
                "memorial": "âœ…",
                "n.campus": "âœ…",
                "hillside": "âœ…",
                "lakeside": "âš ï¸",
                "skyline": "âš ï¸",
                "ridge": "âš ï¸",
                "online": "âœ…",
            },
            "hillside": {
                "bluestone": "âœ…",
                "w.bluestone": "âœ…",
                "memorial": "âœ…",
                "n.campus": "âœ…",
                "hillside": "âœ…",
                "lakeside": "âœ…",
                "skyline": "âš ï¸",
                "ridge": "âš ï¸",
            },
            "lakeside": {
                "bluestone": "âœ…",
                "w.bluestone": "âš ï¸",
                "memorial": "ğŸ›‘",
                "n.campus": "âš ï¸",
                "hillside": "âœ…",
                "lakeside": "âœ…",
                "skyline": "âš ï¸",
                "ridge": "âš ï¸",
                "online": "âœ…",
            },
            "skyline": {
                "bluestone": "âš ï¸",
                "w.bluestone": "âš ï¸",
                "memorial": "ğŸ›‘",
                "n.campus": "âš ï¸",
                "hillside": "âš ï¸",
                "lakeside": "âš ï¸",
                "skyline": "âœ…",
                "ridge": "âœ…",
                "online": "âœ…",
            },
            "ridge": {
                "bluestone": "âš ï¸",
                "w.bluestone": "ğŸ›‘",
                "memorial": "ğŸ›‘",
                "n.campus": "âš ï¸",
                "hillside": "âš ï¸",
                "lakeside": "âš ï¸",
                "skyline": "âœ…",
                "ridge": "âœ…",
                "online": "âœ…",
            },
            "online": {
                "bluestone": "âœ…",
                "w.bluestone": "âœ…",
                "memorial": "âœ…",
                "n.campus": "âœ…",
                "hillside": "âœ…",
                "lakeside": "âœ…",
                "skyline": "âœ…",
                "ridge": "âœ…",
                "online": "âœ…",
            },
        }

        // Get region based on location
        function getRegion(location) {
            for (const region in campusRegion) {
                for (const keyword of campusRegion[region]) {
                    if (location.toLowerCase().includes(keyword.toLowerCase())) {
                        return region;
                    }
                }
            }
            return "unknown";
        }

        // Check if walking is possible between two locations
        function canIGetThere(source, destination) {
            if (source === "unknown" || destination === "unknown") {
                return "â”";
            }
            return timeEstimates[source][destination];
        }

        // CALENDAR

        // const eventPattern = /(?<id>\w+)-0*(?<section>\d+)-(?<name>.+)\n(?<credits>\d+)\n(?<days>\w*)\n?(?<start>[0-9.]*)-(?<end>[0-9.]*)(?: |\n)(?<location>.+)/gm // Original, with only newlines
        const eventPattern = /(?<id>\w+)-0*(?<section>\d+)-(?<name>.+?)(?:\n| )(?<credits>\d+)(?:\n| )(?<days>\w*)(?:\n| )?(?<start>[0-9.]*)-(?<end>[0-9.]*)(?:\n| )(?<location>.+)/gm; // Updated, with optional spaces
        const namePattern = /Student: (?<last>[^0-9,]+),(?<first>[^0-9]+)/m;
        const startDate = Date.parse("2024-01-01");

        const daysToArray = {
            "M": [1],
            "TU": [2],
            "W": [3],
            "TH": [4],
            "F": [5],
            "MWF": [1, 3, 5],
            "MW": [1, 3],
            "WF": [3, 5],
            "MF": [1, 5],
            "TT": [2, 4],
            "": [1] // Online
        }

        const daysToColor = {
            "M": "firebrick",
            "TU": "firebrick",
            "W": "firebrick",
            "TH": "firebrick",
            "F": "firebrick",
            "MWF": "indigo",
            "TT": "purple",
            "MW": "darkgoldenrod",
            "WF": "darkgoldenrod",
            "MF": "darkgoldenrod",
            "": "dimgray" // Online
        }

        function toTitleCase(str) {
            return str.replace(
                /\w\w*/g,
                text => text.charAt(0).toUpperCase() + text.substring(1).toLowerCase()
            );
        }

        // Parse events from input text using RegEx
        function parseEvents(text) {
            let events = [];
            let matches = text.matchAll(eventPattern);

            for (const match of matches) {
                const parsed = match.groups;
                const newEvents = buildEvents(parsed);
                events = events.concat(newEvents);
            }

            return events;
        }

        // Build events from parsed RegEx data
        function buildEvents(parsed) {
            let event = {}; // Base event object
            event.title = `${parsed.id} (Sec ${parsed.section})`;
            event.extendedProps = {
                id: parsed.id,
                location: parsed.location,
                region: getRegion(parsed.location),
                name: parsed.name,
                credits: parsed.credits,
                section: parsed.section,
                days: parsed.days,
            }

            // Check if event has no start time (all day/online)
            if (parsed.start === "") {
                event.allDay = true;
                event.extendedProps.displayTime = "";
            } else {
                event.startTime = parsed.start.replace(".", ":");
                event.endTime = parsed.end.replace(".", ":");
                event.extendedProps.displayTime = `${event.startTime} - ${event.endTime}`;
            }

            // Get days of week from parsed data
            let days = daysToArray[parsed.days];
            if (days === undefined) { // Manually parse days if unusual
                const dayPattern = /(?<M>M)?(?<TU>T(?!H)U?)?(?<W>W)?(?<TH>TH?)?(?<F>F)?/; // Match individual days

                let dayMatch = parsed.days.match(dayPattern);
                let individualDays = Object.keys(dayMatch.groups).filter(key => dayMatch.groups[key] !== undefined);
                days = individualDays.map(day => daysToArray[day]).flat();

                event.color = "darkgreen"; // Custom color for custom days
            } else {
                event.color = daysToColor[parsed.days]; // Set color based on days of week
            }

            // Override color for online classes
            if (event.extendedProps.location === "Online") {
                event.color = "dimgray";
            }

            // Instead of using recurrence, we'll just add the event multiple times (allows for location checks)
            let events = [];
            for (const day of days) {
                let newEvent = { ...event };
                newEvent.extendedProps = { ...event.extendedProps }; // Also deep copy extendedProps
                newEvent.daysOfWeek = [day];
                events.push(newEvent);
            }

            return events;
        }

        // Custom event rendering callback
        function renderEvent(arg) {
            let event = arg.event;

            let container = document.createElement('div');
            container.classList.add('class-container');

            // Title and time
            let title = document.createElement('div');
            title.classList.add('class-title');
            title.textContent = event.title + " @ " + (event.extendedProps.displayTime ? event.extendedProps.displayTime : "Async");
            container.appendChild(title);

            // Description
            let description = document.createElement('div');
            description.classList.add('class-desc');
            description.textContent = toTitleCase(event.extendedProps.name);
            container.appendChild(description);

            // Location and walkability
            let miniContainer = document.createElement('div');
            miniContainer.style.display = "flex";
            miniContainer.style.flexDirection = "row";

            if (event.extendedProps.location === "Online") { // Don't show walkability for online classes
                miniContainer.textContent = "Online";
                miniContainer.classList.add('class-loc');
            } else {
                let walkability = document.createElement('span');
                walkability.classList.add('class-walk');
                walkability.textContent = event.extendedProps.walkability;
                miniContainer.appendChild(walkability);

                let location = document.createElement('span');
                location.classList.add('class-loc');
                location.textContent = `${toTitleCase(event.extendedProps.region)}: ${event.extendedProps.location}`;
                miniContainer.appendChild(location);
            }
            container.appendChild(miniContainer);

            return { domNodes: [container] };
        }

        // Get events by day of week (ignoring online/allDay classes), sorted by start time
        function getEventsByDay(events, day) {
            return events.filter(event => event.daysOfWeek.includes(day) && !event.allDay).sort((a, b) => {
                return a.startTime.localeCompare(b.startTime);
            });
        }

        function addWalkabilityToList(events) {
            for (let i = 0; i < 5; i++) {
                let dayEvents = getEventsByDay(events, i + 1);
                console.log(`Day ${i + 1}`);
                console.log(dayEvents);
                addWalkabilityForDay(dayEvents);
            }
        }

        function addWalkabilityForDay(day) {
            let prevLocation = "";
            let prevTime = "00:00";

            for (let event of day) {
                let location = event.extendedProps.region;

                // Check if start time is no more than 30 minutes after previous end time
                let startTime = event.startTime;
                if (startTime === "") {
                    startTime = "00:00";
                    console.log("Invalid start time!");
                }

                let timeDiff = (new Date(`2024-01-01T${startTime}:00`) - new Date(`2024-01-01T${prevTime}:00`)) / 60000;
                // console.log(`Time diff: ${timeDiff} minutes`);
                if (timeDiff > 30) {
                    event.extendedProps.walkability = "âœ…";
                } else {
                    console.log(`Checking walkability between ${prevLocation} and ${location}: ${canIGetThere(prevLocation, location)}`)
                    event.extendedProps.walkability = canIGetThere(prevLocation, location);
                }

                prevLocation = location;
                prevTime = event.endTime;
            }
        }

        // CHECKLIST

        const genEdClasses = {
            "C1CT": [
                "BUS160",
                "EDUC102",
                "HIST150",
                "ISAT160",
                "PHIL120",
                "PHIL150",
                "SMAD150",
                "UNST300",
            ],
            "C1HC": [
                "SCOM121",
                "SCOM122",
                "SCOM123",
            ],
            "C1W": [
                "WRTC103",
            ],
            "C2HQC": [
                "AMST200",
                "ANTH205",
                "HIST101",
                "HIST102",
                "HUM250",
                "HUM251",
                "HUM252",
                "LAXC252",
                "PHIL101",
                "REL101",
                "REL102",
            ],
            "C2VPA": [
                "ART200",
                "ARTH205",
                "ARTH206",
                "DANC215",
                "MUS200",
                "MUS203",
                "MUS206",
                "THEA210",
            ],
            "C2L": [
                "ENG221",
                "ENG222",
                "ENG235",
                "ENG236",
                "ENG239",
                "ENG247",
                "ENG248",
                "ENG260",
                "HUM200",
            ],
            "C3QR": [
                "ISAT151",
                "ISAT251",
                "MATH103",
                "MATH105",
                "MATH110",
                "MATH205",
                "MATH220",
                "MATH229",
                "MATH231",
                "MATH235",
            ],
            "C3PP": [
                "ASTR120",
                "ASTR121",
                "CHEM120",
                "CHEM131",
                "ENVT101",
                "ISAT100",
                "ISAT112",
                "ISCI101",
                "ISCI172",
                "PHYS121",
                "PHYS140",
                "PHYS215",
                "PHYS240",
            ],
            "C3NS": [
                "ANTH196",
                "BIO103",
                "BIO140",
                "BIO270",
                "GEOL102",
                "GEOL110",
                "GEOL115",
                "GEOL210",
                "GEOL211",
                "ISAT113",
                "ISCI171",
            ],
            "C3L": [
                "ANTH196L",
                "BIO140L",
                "BIO270L",
                "CHEM131L",
                "GEOL110L",
                "GEOL115L",
                "ISAT113L",
                "ISCI104",
                "ISCI173",
                "PHYS140L",
                "PHYS240L",
            ],
            "C4AE": [
                "HIST225",
                "JUST225",
                "POSC225",
            ],
            "C4GE": [
                "AAAD200",
                "ANTH195",
                "ECON200",
                "GEOG200",
                "POSC200",
                "SOCI110",
            ],
            "C5WD": [
                "HTH100",
                "KIN100",
            ],
            "C5SD": [
                "PSYC101",
                "PSYC160",
                "SOCI140",
                "WGSS200",
            ],
        }

        const classLookup = {};
        for (const area in genEdClasses) {
            for (const classId of genEdClasses[area]) {
                classLookup[classId] = area;
            }
        }

        const genEdAreas = {
            "Madison Foundations": ["C1CT", "C1HC", "C1W"],
            "Sociocultural and Wellness Area": ["C5WD", "C5SD"],
            "Arts and Humanities": ["C2HQC", "C2VPA", "C2L"],
            "American and Global Perspectives": ["C4AE", "C4GE"],
            "The Natural World": ["C3QR", "C3PP", "C3NS", "C3L"],
        }
        
        const areaLookup = {};
        for (const area in genEdAreas) {
            for (const req of genEdAreas[area]) {
                areaLookup[req] = area;
            }
        }

        const requirementNames = {
            "C1CT": "Critical Thinking",
            "C1HC": "Human Communication",
            "C1W": "Writing",
            "C2HQC": "Human Questions and Contexts",
            "C2VPA": "Visual and Performing Arts",
            "C2L": "Literature",
            "C3QR": "Quantitative Reasoning",
            "C3PP": "Physical Principles",
            "C3NS": "Natural Systems",
            "C3L": "Lab Experience",
            "C4AE": "The American Experience",
            "C4GE": "The Global Experience",
            "C5WD": "Wellness Domain",
            "C5SD": "Sociocultural Domain",
        }

        const labReq = {
            "CHEM131": "CHEM131L",
            "PHYS140": "PHYS140L",
            "PHYS240": "PHYS240L",
            "BIO140": "BIO140L",
            "BIO270": "BIO270L",
            "GEOL110": "GEOL110L",
            "GEOL115": "GEOL115L",
            "ISAT113": "ISAT113L",
            "ANTH196": "ANTH196L",
        }

        function processChecklist(text) {
            
        }

        // EVENT HANDLERS

        // Hotkeys for input
        document.getElementById('input').addEventListener('keydown', (ev) => {
            if (ev.key === "Enter" && ev.ctrlKey || ev.key === "s" && ev.ctrlKey) {
                ev.preventDefault();
                document.getElementById('submit-btn').click();
            } else if (ev.key === "v" && ev.ctrlKey) {
                setTimeout(() => {
                    document.getElementById('submit-btn').click();
                }, 0); // Use setTimeout to allow paste to complete
            }
        });

        // Clear button handler
        document.getElementById('clear-btn').addEventListener('click', (ev) => {
            // Hide schedule
            document.getElementById('schedule').hidden = true;
            
            // Clear input
            let input = document.getElementById('input');
            input.value = "";
            input.focus();
        });

        // Submit button handler
        document.getElementById('submit-btn').addEventListener('click', (ev) => {
            ev.preventDefault();
            document.getElementById('schedule').hidden = false;

            const input = document.getElementById('input').value;
            sessionStorage.setItem('input', input);

            // Get student name
            let name = input.match(namePattern);
            if (name) {
                let fullname = `${name.groups.first.trim()} ${name.groups.last.trim()}`;
                document.getElementById('schedule-title').textContent = `${fullname}`;
            } else {
                document.getElementById('schedule-title').textContent = "Schedule";
            }

            // Check off items in checklist
            processChecklist(input);

            // Parse events
            const allEvents = parseEvents(input);
            addWalkabilityToList(allEvents);

            // Create calendar
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                editable: false,
                initialDate: startDate,
                hiddenDays: [0, 6],
                headerToolbar: {
                    start: "",
                    center: "",
                    end: ""
                },
                slotMinTime: "08:00:00",
                slotMaxTime: "20:00:00",
                slotEventOverlap: false,
                dayHeaderFormat: { weekday: "long" },
                events: allEvents,
                eventContent: renderEvent,
            });
            calendar.render();

            window.scrollTo(0, document.getElementById('schedule').offsetTop);
        });

        // Copy button handler
        document.getElementById('copy-btn').addEventListener('click', () => {
            // Hide copy button and top section
            let btn = document.getElementById('buttons');
            btn.hidden = true;

            let schedule = document.getElementById('schedule');
            let calendar = document.getElementById('calendar');
            html2canvas(schedule, {
                scale: 2,
                windowWidth: calendar.scrollWidth + 20,
            }).then(canvas => {
                // Copy to clipboard
                canvas.toBlob(blob => {
                    navigator.clipboard.write([
                        new ClipboardItem({
                            'image/png': blob
                        })
                    ]);
                });

                btn.hidden = false;
            });
        });

        // Download button handler
        document.getElementById('download-btn').addEventListener('click', () => {
            // Hide download button and top section
            let btn = document.getElementById('buttons');
            btn.hidden = true;

            let schedule = document.getElementById('schedule');
            let calendar = document.getElementById('calendar');
            html2canvas(schedule, {
                scale: 2,
                windowWidth: calendar.scrollWidth + 20,
            }).then(canvas => {
                // Save to png
                let imgData = canvas.toDataURL('image/png');

                let link = document.createElement('a');
                link.download = `${document.getElementById('schedule-title').textContent}.png`;
                link.href = imgData;
                link.click();

                btn.hidden = false;
            });
        });

        // Load previous input
        let prevInput = sessionStorage.getItem('input');
        if (prevInput) {
            document.getElementById('input').value = prevInput;
        }
    </script>
</body>

</html>